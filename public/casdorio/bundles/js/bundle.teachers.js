!function(){"use strict";!function(){const e={files:{maxSize:5242880,allowedTypes:["image/jpeg","image/jpg","image/png","image/gif","image/webp"],allowedExtensions:[".jpg",".jpeg",".png",".gif",".webp"]},api:{timeout:3e4,retries:3},messages:{success:{created:"Professor cadastrado com sucesso",updated:"Professor atualizado com sucesso",deleted:"Professor removido com sucesso"},error:{generic:"Erro ao processar solicitação",fileSize:"Arquivo muito grande. Tamanho máximo: 5MB",fileType:"Tipo de arquivo não permitido",required:"Por favor, preencha todos os campos obrigatórios",network:"Erro de conexão. Tente novamente"},loading:{processing:"Processando arquivos...",saving:"Salvando dados...",loading:"Carregando..."}}};let t=null,a=null,r=null,s=null,o=null,i=!1,n=null;const l={validateFile:t=>t?t.size>e.files.maxSize?{isValid:!1,message:e.messages.error.fileSize}:e.files.allowedTypes.includes(t.type)?{isValid:!0,message:""}:{isValid:!1,message:e.messages.error.fileType+": "+e.files.allowedExtensions.join(", ")}:{isValid:!0,message:""},convertFileToBase64(e){return new Promise(((t,a)=>{if(!e)return void t(null);const r=this.validateFile(e);if(!r.isValid)return void a(new Error(r.message));const s=new FileReader;s.onload=()=>{const a=s.result.split(",")[1];t({name:e.name,type:e.type,size:e.size,data:a,lastModified:e.lastModified})},s.onerror=()=>a(new Error("Erro ao ler arquivo")),s.readAsDataURL(e)}))},async convertFormDataToJSON(e){const t={},a=[];for(let[r,s]of e.entries())s instanceof File?s.size>0?a.push(this.convertFileToBase64(s).then((e=>{t[r]=e})).catch((e=>{throw new Error(`Erro no arquivo ${r}: ${e.message}`)}))):t[r]=null:t[r]=s.trim();return a.length>0&&await Promise.all(a),t},showImagePreview(e,t){if(e&&e.type.startsWith("image/")){const a=new FileReader;a.onload=e=>{const a=document.getElementById(t);a&&(a.src=e.target.result,a.style.display="block",a.classList.add("img-thumbnail"))},a.readAsDataURL(e)}},debounce(e,t){let a;return function(...r){clearTimeout(a),a=setTimeout((()=>{clearTimeout(a),e(...r)}),t)}}},d={validateForm(e){if(!e.checkValidity()){const t=e.querySelector(":invalid");return t&&(t.focus(),this.showFieldError(t)),!1}return this.clearFormErrors(e),!0},showFieldError(e){const t=this.getOrCreateErrorElement(e);let a="";a=e.validity.valueMissing?e.getAttribute("data-required-message")||"Este campo é obrigatório":e.validity.typeMismatch?e.getAttribute("data-type-message")||"Formato inválido":e.validity.patternMismatch?e.getAttribute("data-pattern-message")||"Formato inválido":e.validity.tooShort?e.getAttribute("data-minlength-message")||`Mínimo ${e.minLength} caracteres`:e.validity.tooLong?e.getAttribute("data-maxlength-message")||`Máximo ${e.maxLength} caracteres`:e.validationMessage,t.textContent=a,t.style.display="block",e.classList.add("is-invalid")},getOrCreateErrorElement(e){const t=e.id||e.name;let a=document.getElementById(`error-${t}`);return a||(a=document.createElement("div"),a.id=`error-${t}`,a.className="invalid-feedback d-block",a.style.display="none",e.parentNode&&e.parentNode.insertBefore(a,e.nextSibling)),a},clearFormErrors(e){e.querySelectorAll(".is-invalid").forEach((e=>{e.classList.remove("is-invalid")}));e.querySelectorAll(".invalid-feedback").forEach((e=>{e.style.display="none"}))},showValidationErrors(e){Object.keys(e).forEach((t=>{const a=document.querySelector(`[name="${t}"]`);if(a){const r=this.getOrCreateErrorElement(a);r.textContent=e[t],r.style.display="block",a.classList.add("is-invalid")}}))}},c={clearModalForm(){if(a){a.reset(),d.clearFormErrors(a);a.querySelectorAll('img[id$="-preview"]').forEach((e=>{e.style.display="none",e.src=""})),i=!1,n=null}},openCreateModal(){this.clearModalForm(),t&&t.show()},openEditModal(e,r){this.clearModalForm(),i=!0,n=e,r&&a&&Object.keys(r).forEach((e=>{const t=a.querySelector(`[name="${e}"]`);t&&"file"!==t.type&&(t.value=r[e]||"")})),t&&t.show()}},m={async saveTeacher(t){const a=i?`professores/api/editar/${n}/salvar`:"professores/api/salvar",r=i?"PUT":"POST",s=Array.from(t.entries()).some((([e,t])=>t instanceof File&&t.size>0));s&&Swal.fire({title:e.messages.loading.processing,text:"Por favor, aguarde enquanto processamos as imagens.",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const o=await l.convertFormDataToJSON(t);return s&&Swal.close(),axios({method:r,url:a,data:{data:o},headers:{"Content-Type":"application/json",Accept:"application/json"},timeout:e.api.timeout})},deleteTeacher:async t=>axios({method:"DELETE",url:`/professores/api/deletar/${t}`,headers:{Accept:"application/json"},timeout:e.api.timeout})},u={async handleSaveTeacher(n){if(n.preventDefault(),a&&d.validateForm(a)){s.classList.remove("d-none"),r.disabled=!0;try{const r=new FormData(a);await m.saveTeacher(r),Swal.fire({icon:"success",title:"Sucesso",text:i?e.messages.success.updated:e.messages.success.created}),t.hide(),o&&o.ajax.reload(),c.clearModalForm()}catch(t){console.error("Erro ao salvar professor:",t);let a=e.messages.error.generic;if(t.response&&t.response.data&&t.response.data.errors)return void d.showValidationErrors(t.response.data.errors);t.message?a=t.message:t.response&&t.response.data&&t.response.data.message&&(a=t.response.data.message),Swal.fire({icon:"error",title:"Erro",text:a})}finally{s.classList.add("d-none"),r.disabled=!1}}},handleImagePreview(e){if("file"===e.target.type&&e.target.accept&&e.target.accept.includes("image")){const t=e.target.files[0];if(t){const a=e.target.getAttribute("data-preview");a&&l.showImagePreview(t,a)}}},handleRealTimeValidation:l.debounce((function(e){const t=e.target;if(t.checkValidity()){t.classList.remove("is-invalid");const e=document.getElementById(`error-${t.id||t.name}`);e&&(e.style.display="none")}else d.showFieldError(t)}),300),async handleDeleteTeacher(t,a){if((await Swal.fire({title:"Confirmar exclusão",text:`Deseja realmente excluir o professor ${a}?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sim, excluir",cancelButtonText:"Cancelar"})).isConfirmed)try{await m.deleteTeacher(t),Swal.fire({icon:"success",title:"Sucesso",text:e.messages.success.deleted}),o&&o.ajax.reload()}catch(t){console.error("Erro ao deletar professor:",t),Swal.fire({icon:"error",title:"Erro",text:e.messages.error.generic})}}},g={init(){this.initializeElements(),this.bindEvents(),this.initializeDataTable(),console.log("Sistema de Gerenciamento de Professores iniciado")},initializeElements(){const e=document.getElementById("teacherModal");e&&"undefined"!=typeof bootstrap&&(t=new bootstrap.Modal(e)),a=document.getElementById("teacherModalForm"),r=document.getElementById("saveTeacherBtn"),s=document.getElementById("saveTeacherSpinner");document.getElementById("teachersTable")&&"undefined"!=typeof $&&$.fn.DataTable},bindEvents(){if(r&&r.addEventListener("click",u.handleSaveTeacher),document.addEventListener("change",u.handleImagePreview),a){a.querySelectorAll("input, select, textarea").forEach((e=>{e.addEventListener("blur",u.handleRealTimeValidation),e.addEventListener("input",u.handleRealTimeValidation)}))}document.addEventListener("click",(e=>{if(e.target.classList.contains("btn-edit-teacher")){const t=e.target.getAttribute("data-teacher-id"),a=JSON.parse(e.target.getAttribute("data-teacher-data")||"{}");c.openEditModal(t,a)}if(e.target.classList.contains("btn-delete-teacher")){const t=e.target.getAttribute("data-teacher-id"),a=e.target.getAttribute("data-teacher-name");u.handleDeleteTeacher(t,a)}e.target.classList.contains("btn-new-teacher")&&c.openCreateModal()}))},initializeDataTable(){const e=document.getElementById("teachersTable");e&&"undefined"!=typeof $&&$.fn.DataTable&&(o=$(e).DataTable({processing:!0,serverSide:!0,ajax:{url:"./professores/api/listar",type:"POST",dataSrc:function(e){return e.recordsTotal=e.data.recordsTotal||0,e.recordsFiltered=e.data.recordsFiltered||0,e.draw=e.data.draw||1,e.data.data.teachers||[]}},language:{url:"//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json"},responsive:!0,order:[[1,"asc"]],columnDefs:[{targets:-1,orderable:!1,searchable:!1}]}))}};window.TeacherManager=g,window.TeacherModalManager=c,window.TeacherEventHandlers=u,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{g.init()})):g.init()}()}();
